"use strict";!function(){var t=function(t,e){function n(t,e){var n=[];return t.forEach(function(t){var r=new Promise(function(n,r){var i=t.property,a=t.operator,d=t.value,o=e[i],l=f.operatorFunctions[a];l(o,d).then(function(t){n(t)})});n.push(r)}),Promise.all(n)}function r(t){var e=new CustomEvent("nodeClick",{detail:t});window.dispatchEvent(e)}function i(t,e,n){if(t){e(t);var r=n(t);if(r)for(var a=r.length,d=0;d<a;d++)i(r[d],e,n)}}function a(t,e){for(var n=t.length-1;n>=0;n--)for(var r=0;r<e.length;r++)t[n]&&t[n].id===e[r].id&&t.splice(n,1);return t}var d=e.layout.svgMargin,o=(e.layout.svgWidth-e.layout.svgMargin.left-e.layout.svgMargin.right,e.layout.svgHeight-e.layout.svgMargin.top-e.layout.svgMargin.bottom),l=e.layout.nodeWidth,c=e.layout.nodeHeight,s=e.layout.nodeMargin,h=e.layout.transitionDuration,u="#"+e.layout.divId,f=this,p=0;this.options=e,this.operatorFunctions=e.operatorFunctions,this.root=null,this.treeData=t,this.nodes=null,this.links=null,this.treemap=d3.tree().nodeSize([l+s.x,c+s.y]).separation(function(t,e){return t.parent==e.parent?1:1.25}),this.root=d3.hierarchy(this.treeData,function(t){return t.children});var y=d3.zoom().scaleExtent([.25,4]).on("zoom",function(){g.attr("transform","translate("+d3.event.transform.x+","+d3.event.transform.y+")scale("+d3.event.transform.k+")")}),m=d3.select(u).append("svg").attr("width","100%").attr("height",o+d.top+d.bottom).append("g").attr("transform","translate(0,-9999999) scale(1)").attr("id","treePanel"),g=d3.select("#treePanel"),v=d3.select("svg");v.call(y),d3.select(u).on("click",function(t){var e=d3.event.target.className.baseVal.indexOf("node-rect")!=-1;e||f.setHighlighted(!1,!0)}),this.destroy=function(){d3.select(u).select("svg").remove()},this.queryDecisionTree=function(t){function e(r){return new Promise(function(i,d){r.children||i({result:r.data.classification,path:a});var o=r.data.rules;n(o,t).then(function(t){var n=o.filter(function(t){return t.condition&&"OR"==t.condition}),d={0:[]},l=0,c=0;n.length>0?o.forEach(function(e){e.condition&&"AND"!=e.condition?e.condition&&"OR"==e.condition&&(c++,d[c]=[t[l]]):d[c].push(t[l]),l++}):d[0]=t;var s=!1,h=Object.keys(d);h.forEach(function(t){d[t].every(function(t){return 1==t})&&(s=!0)}),a+=s?1:0,i(s?e(r.children[1]):e(r.children[0]))})})}var r=this.treeData.descendants(),i=r[0],a="";return e(i)},this.cloneAndStripNode=function(t){function e(t){delete t.height,delete t.depth,delete t.id,delete t.parent,delete t.x,delete t.x0,delete t.y,delete t.y0,t.name=t.data.name,t.data.rules&&(t.rules=t.data.rules),t.data.classification&&(t.classification=t.data.classification),delete t.data,t.children&&t.children.forEach(function(t){e(t)})}var n=JSON.stringify(t,function(t,e){if("parent"!=t)return e});return n=JSON.parse(n),e(n),n},this.serialiseTreeToJSON=function(){function t(e){delete e.height,delete e.depth,delete e.id,delete e.parent,delete e.x,delete e.x0,delete e.y,delete e.y0,e.name=e.data.name,e.data.rules&&(e.rules=e.data.rules),e.data.classification&&(e.classification=e.data.classification),delete e.data,e.children&&e.children.forEach(function(e){t(e)})}var e=this.treeData.descendants(),n=JSON.stringify(e[0],function(t,e){if("parent"!=t)return e});return n=JSON.parse(n),t(n),JSON.stringify(n)},this.pruneNode=function(t){t&&t.children&&t.children.length>0&&(delete t.children,delete t.data.children,this.update(t))},this.deleteNode=function(t){var e=this;i(this.treeData,function(n){if(n.children){var r=!0,i=!1,d=void 0;try{for(var o,l=n.children[Symbol.iterator]();!(r=(o=l.next()).done);r=!0){var c=o.value;if(c==t){n.children=a(n.children,[c]),e.update(e.root);break}}}catch(s){i=!0,d=s}finally{try{!r&&l["return"]&&l["return"]()}finally{if(i)throw d}}}},function(t){return t.children&&t.children.length>0?t.children:null})},this.updateNodeData=function(t,e){t.data=e,this.update(t)},this.updateDecisionNodeData=function(t,e){t.data.name=e.name,t.data.children||(t.data.children=[]),e.rules&&(t.data.rules=e.rules),t.data.children[0].name=e.children[0].name,t.data.children[0].hasOwnProperty("rules")&&(t.data.children[0].rules=e.children[0].rules||null),t.data.children[0].hasOwnProperty("classification")&&(t.data.children[0].classification=e.children[0].classification),t.data.children[1].name=e.children[1].name,t.data.children[1].hasOwnProperty("rules")&&(t.data.children[1].rules=e.children[1].rules||null),t.data.children[1].hasOwnProperty("classification")&&(t.data.children[1].classification=e.children[1].classification),this.update(t),this.setHighlighted(t,!0)},this.addChildNodes=function(t,e){!t||t.children&&2==t.children.length||(e.forEach(function(e){var n=d3.hierarchy(e);n.depth=t.depth+1,n.height=t.height-1,n.parent=t,n.id=+new Date+parseInt(1e4*Math.random()),t.children||(t.children=[],t.data.children=[]),t.children.push(n),t.data.children.push(n.data)}),this.update(t),this.setHighlighted(t,!0),r(t))},this.centerNode=function(t){var e=d3.zoomTransform(v.node()),n=-t.y0,r=-t.x0;n=n*e.k+f.options.layout.svgWidth/2,r=r*e.k+f.options.layout.svgHeight/2,v.transition().duration(h).call(y.transform,d3.zoomIdentity.translate(n,r).scale(e.k))},this.collapse=function(t){t.children&&(t._children=t.children,t._children.forEach(f.collapse),t.children=null)},this.expand=function(t){t._children&&(t.children=t._children,t.children.forEach(f.expand),t._children=null)},this.collapseAll=function(){this.root.children.forEach(f.collapse),this.update(root)},this.expandAll=function(){this.root.children.forEach(f.expand),this.update(root)};var x=void 0;this.setHighlighted=function(t,e){return d3.selectAll(".node").select("rect").style("fill",function(t){return t._children||t.children?"#FFF":"#CCC"}),t&&t.id!=x||t.id&&e?(d3.select("#node-"+t.id).select("rect").style("fill",f.options.colors&&f.options.colors.nodeHighlight||"#2199e8"),x=t.id,!0):(x=null,!1)},this.fitBounds=function(t,e){var n=g.node().getBBox(),r=g.node().parentElement,i=r.clientWidth,a=r.clientHeight,d=n.width,o=n.height,l=n.x+d/2,c=n.y+o/2;if(0!=d&&0!=o){var s=(t||.75)/Math.max(d/i,o/a),h=[i/2-s*l,a/2-s*c];v.transition().duration(e||0).call(y.transform,d3.zoomIdentity.translate(h[0],h[1]).scale(s))}},this.adjustBounds=function(t){v.transition().duration(t.duration||0).call(y.translateBy,t.x,t.y)},this.update=function(t){function e(t,e){var n="M "+t.x+" "+t.y+"\n\t\t\t\t            C "+(t.x+e.x)/2+" "+t.y+",\n\t\t\t\t              "+(t.x+e.x)/2+" "+e.y+",\n\t\t\t\t              "+e.x+" "+e.y;return n}function n(t){var e=f.setHighlighted(t,!1);r(e?t:null)}this.treeData=this.treemap(this.root),this.nodes=this.treeData.descendants(),this.links=this.treeData.descendants().slice(1),this.nodes.forEach(function(t){t.y=t.depth*s.y});var i=m.selectAll("g.node").data(f.nodes,function(t){return t.id||(t.id=++p)}),a=i.enter().append("g").attr("class","node").attr("id",function(t){return"node-"+t.id}).attr("transform",function(e){if(t.x0)return"translate("+t.x0+","+t.y0+")"}).on("click",n),d=i.selectAll("rect.node-rect");a.append("rect").attr("width",l/2).attr("class",function(t){return t.data.children?"node-rect":t.parent&&t.parent.children[1].data.name==t.data.name?"node-rect truthy-node":"node-rect falsey-node"}).attr("height",function(t){return t._children||t.children?c/2:c/3}).attr("transform",function(t){return t._children||t.children?"rotate(45)":""}).attr("x",-(l/4)).attr("y",function(t){return t._children||t.children?-(c/4):-(c/5.5)}).attr("stroke","black").attr("stroke-width",2).attr("cursor","pointer").style("fill",function(t){return t._children||t.children?"#FFF":"#CCC"}),d.attr("height",function(t){return t._children||t.children?c/2:c/3}).attr("transform",function(t){return t._children||t.children?"rotate(45)":""}).attr("x",-(l/4)).attr("y",function(t){return t._children||t.children?-(c/4):-(c/5.5)}).attr("class",function(t){return t.data.children?"node-rect":t.parent&&t.parent.children[1].data.name==t.data.name?"node-rect truthy-node":"node-rect falsey-node"}).style("fill",function(t){return t._children||t.children?"#FFF":"#CCC"});var o=i.selectAll("text.node-name");o.empty()||o.size()!=this.nodes.length?a.append("text").attr("dy",".35em").attr("class","node-name").attr("text-anchor","middle").text(function(t){return t.data.name}):o.text(function(t){return t.data.name});var u=i.selectAll("text.link-name");u.empty()||u.size()!=this.nodes.length?a.append("text").attr("dy",".65em").attr("class","link-label").attr("x",function(t){if(t.parent)return(t.parent.x-t.x)/2}).attr("y",function(t){if(t.parent)return(t.parent.y-t.y)/2}).attr("text-anchor","middle").text(function(t){if(t.parent)return t.parent&&t.parent.children[1].data.name==t.data.name?"TRUE":"FALSE"}):u.text(function(t){if(t.parent)return t.parent&&t.parent.children[1].data.name==t.data.name?"TRUE":"FALSE"});var y=a.merge(i);y.transition().duration(h).attr("transform",function(t){return"translate("+t.x+","+t.y+")"}),y.select("rect.node").attr("width",l).attr("height",c).style("fill",function(t){return t._children?"lightsteelblue":"#fff"}).attr("cursor","pointer");var g=i.exit().transition().duration(h).attr("transform",function(e){return"translate("+t.x+","+t.y+")"}).remove();g.select("rect").attr("width",0).attr("height",0),g.select("text").style("fill-opacity",1e-6);var v=m.selectAll("path.link").data(f.links,function(t){return t.id}).attr("class",function(t){return t.parent&&t.parent.children[1].data.name==t.data.name?"link truthy-link":"link falsey-link"}),x=v.enter().insert("path","g").attr("class",function(t){return t.parent&&t.parent.children[1].data.name==t.data.name?"link truthy-link":"link falsey-link"}).attr("d",function(n){if(!t.x0)return e({x:0,y:0},{x:0,y:0});var r={x:t.x0,y:t.y0};return e(r,r)}),k=x.merge(v);k.transition().duration(h).attr("d",function(t){return e(t,t.parent)});v.exit().transition().duration(h).attr("d",function(n){var r={x:t.x,y:t.y};return e(r,r)}).remove();f.nodes.forEach(function(t){t.x0=t.x,t.y0=t.y})},this.update(this.root),setTimeout(function(){f.fitBounds(.7,0)},1e3)};"function"==typeof define&&define.amd?define(function(){return t}):"undefined"!=typeof exports?("undefined"!=typeof module&&module.exports&&(exports=module.exports=t),exports.DecisionTreeBuilder=t):window.DecisionTreeBuilder=t}(void 0);