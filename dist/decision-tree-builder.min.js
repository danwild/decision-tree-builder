"use strict";!function(){var t=function(t,e){function n(t){return d3.selectAll(".node").select("rect").style("fill",function(t){return t._children||t.children?"#FFF":"#CCC"}),t&&t.id!=g?(d3.select("#node-"+t.id).select("rect").style("fill","#10B0F0"),void(g=t.id)):void(g=null)}function r(t,e,n){if(t){e(t);var a=n(t);if(a)for(var i=a.length,o=0;o<i;o++)r(a[o],e,n)}}function a(t,e){for(var n=t.length-1;n>=0;n--)for(var r=0;r<e.length;r++)t[n]&&t[n].id===e[r].id&&t.splice(n,1);return t}function i(){d3.select(p).select("svg").select("g").attr("transform","translate("+d3.event.transform.x+","+d3.event.transform.y+") scale("+d3.event.transform.k+")")}var o=e.layout.svgMargin,l=e.layout.svgWidth-e.layout.svgMargin.left-e.layout.svgMargin.right,d=e.layout.svgHeight-e.layout.svgMargin.top-e.layout.svgMargin.bottom,c=e.layout.nodeWidth,s=e.layout.nodeHeight,h=e.layout.nodeMargin,u=d3.zoom().scaleExtent(e.layout.zoomScale).on("zoom",i),f=e.layout.transitionDuration,p="#"+e.layout.divId,y=this,v=0;this.operatorFunctions=e.operatorFunctions,this.root=null,this.treeData=t,this.nodes=null,this.links=null,this.treemap=d3.tree().nodeSize([c+h.x,s+h.y]).separation(function(t,e){return t.parent==e.parent?1:1.25}),this.root=d3.hierarchy(this.treeData,function(t){return t.children});var x=d3.select(p).append("svg").attr("width","100%").attr("height",d+o.top+o.bottom).append("g").append("g").attr("transform","translate("+l/2+","+(o.top+s)+")");d3.select(p).select("svg").call(u),this.queryDecisionTree=function(t){function e(n){return new Promise(function(r,i){n.children||r({result:n.data.classification,path:a});var o=n.data.property,l=n.children[1].data.operator,d=n.children[1].data.value,c=t[o],s=y.operatorFunctions[l];s(d,c).then(function(t){a+=t?1:0,r(t?e(n.children[1]):e(n.children[0]))})})}var n=this.treeData.descendants(),r=n[0],a="";return e(r)},this.serialiseTreeToJSON=function(){function t(e){delete e.height,delete e.depth,delete e.id,delete e.parent,delete e.x,delete e.x0,delete e.y,delete e.y0,e.label=e.data.label,e.property=e.data.property,e.data.operator&&(e.operator=e.data.operator),e.data.value&&(e.value=e.data.value),e.data.classification&&(e.classification=e.data.classification),delete e.data,e.children&&e.children.forEach(function(e){t(e)})}var e=this.treeData.descendants(),n=JSON.stringify(e[0],function(t,e){if("parent"!=t)return e});return n=JSON.parse(n),t(n),JSON.stringify(n)},this.pruneNode=function(t){t.children&&t.children.length>0&&(delete t.children,delete t.data.children,this.update(t))},this.deleteNode=function(t){var e=this;r(this.treeData,function(n){if(n.children){var r=!0,i=!1,o=void 0;try{for(var l,d=n.children[Symbol.iterator]();!(r=(l=d.next()).done);r=!0){var c=l.value;if(c==t){n.children=a(n.children,[c]),e.update(e.root);break}}}catch(s){i=!0,o=s}finally{try{!r&&d["return"]&&d["return"]()}finally{if(i)throw o}}}},function(t){return t.children&&t.children.length>0?t.children:null})},this.updateNodeData=function(t,e){t.data=e,this.update(t)},this.addChildNodes=function(t,e){t.children&&2==t.children.length||(e.forEach(function(e){var n=d3.hierarchy(e);n.depth=t.depth+1,n.height=t.height-1,n.parent=t,n.id=+new Date+parseInt(1e4*Math.random()),t.children||(t.children=[],t.data.children=[]),t.children.push(n),t.data.children.push(n.data)}),this.update(t))},this.resetZoom=function(){x.transition().call(u.transform,d3.zoomIdentity)},this.collapse=function(t){t.children&&(t._children=t.children,t._children.forEach(y.collapse),t.children=null)},this.expand=function(t){t._children&&(t.children=t._children,t.children.forEach(y.expand),t._children=null)},this.colapseAll=function(){this.root.children.forEach(y.collapse),this.update(root)},this.expandAll=function(){this.root.children.forEach(y.expand),this.update(root)},this.update=function(t){function e(t,e){var n="M "+t.x+" "+t.y+"\n\t\t\t\t            C "+(t.x+e.x)/2+" "+t.y+",\n\t\t\t\t              "+(t.x+e.x)/2+" "+e.y+",\n\t\t\t\t              "+e.x+" "+e.y;return n}function r(t){n(t);var e=new CustomEvent("nodeClick",{detail:t});window.dispatchEvent(e)}console.log("update"),this.treeData=this.treemap(this.root),this.nodes=this.treeData.descendants(),this.links=this.treeData.descendants().slice(1),this.nodes.forEach(function(t){t.y=t.depth*h.y});var a=x.selectAll("g.node").data(y.nodes,function(t){return t.id||(t.id=++v)}),i=a.enter().append("g").attr("class","node").attr("id",function(t){return"node-"+t.id}).attr("transform",function(e){if(t.x0)return"translate("+t.x0+","+t.y0+")"}).on("click",r),o=a.selectAll("rect.node-rect");i.append("rect").attr("width",c/2).attr("class","node-rect").attr("height",function(t){return t._children||t.children?s/2:s/3}).attr("transform",function(t){return t._children||t.children?"rotate(45)":""}).attr("x",-(c/4)).attr("y",function(t){return t._children||t.children?-(s/4):-(s/5.5)}).attr("stroke","black").attr("stroke-width",2).attr("cursor","pointer").style("fill",function(t){return t._children||t.children?"#FFF":"#CCC"}),o.attr("height",function(t){return t._children||t.children?s/2:s/3}).attr("transform",function(t){return t._children||t.children?"rotate(45)":""}).attr("x",-(c/4)).attr("y",function(t){return t._children||t.children?-(s/4):-(s/5.5)}).style("fill",function(t){return t._children||t.children?"#FFF":"#CCC"});var l=a.selectAll("text.node-label");l.empty()||l.size()!=this.nodes.length?i.append("text").attr("dy",".35em").attr("class","node-label").attr("text-anchor","middle").text(function(t){return t.data.label}):l.text(function(t){return console.log(t.data.label),t.data.label});var d=a.selectAll("text.link-label");d.empty()||d.size()!=this.nodes.length?i.append("text").attr("dy",".65em").attr("class","link-label").attr("x",function(t){if(t.parent)return(t.parent.x-t.x)/2}).attr("y",function(t){if(t.parent)return(t.parent.y-t.y)/2}).attr("text-anchor","middle").text(function(t){if(t.parent)return t.data.operator+" "+t.data.value}):d.text(function(t){if(t.parent)return t.data.operator+" "+t.data.value});var u=i.merge(a);u.transition().duration(f).attr("transform",function(t){return"translate("+t.x+","+t.y+")"}),u.select("rect.node").attr("width",c).attr("height",s).style("fill",function(t){return t._children?"lightsteelblue":"#fff"}).attr("cursor","pointer");var p=a.exit().transition().duration(f).attr("transform",function(e){return"translate("+t.x+","+t.y+")"}).remove();p.select("rect").attr("width",0).attr("height",0),p.select("text").style("fill-opacity",1e-6);var g=x.selectAll("path.link").data(y.links,function(t){return t.id}),m=g.enter().insert("path","g").attr("class","link").attr("d",function(n){if(!t.x0)return e({x:0,y:0},{x:0,y:0});var r={x:t.x0,y:t.y0};return e(r,r)}),b=m.merge(g);b.transition().duration(f).attr("d",function(t){return e(t,t.parent)});g.exit().transition().duration(f).attr("d",function(n){var r={x:t.x,y:t.y};return e(r,r)}).remove();y.nodes.forEach(function(t){t.x0=t.x,t.y0=t.y})};var g=void 0;this.update(this.root)};"function"==typeof define&&define.amd?define(function(){return t}):"undefined"!=typeof exports?("undefined"!=typeof module&&module.exports&&(exports=module.exports=t),exports.DecisionTreeBuilder=t):window.DecisionTreeBuilder=t}(void 0);